<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√£o MQTT - Medidor de Combust√£o</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="config-device-container">
        <div class="header">
            <h1 class="config-device-title">üì° Configura√ß√£o MQTT</h1>
            <a class="btn btn-voltar" href="/admin">‚¨ÖÔ∏è Voltar</a>
        </div>

        <div class="brand">
            <div class="brand-main">
                <img src="https://infitech.com.br/images/logo.jpg" alt="Infitech - Automa√ß√£o" class="brand-logo">
                <h2 class="brand-company">Infitech - Automa√ß√£o</h2>
            </div>
            <div class="brand-program">Programa: <strong>MCT-01</strong></div>
        </div>

        <form id="mqttForm" method="POST" action="/mqtt_config" enctype="multipart/form-data">
            <!-- Configura√ß√£o Geral -->
            <div class="config-card">
                <h2>‚öôÔ∏è Configura√ß√£o Geral</h2>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="mqtt_enabled" name="mqtt_enabled"{{MQTT_ENABLED_CHECKED}}>
                        Habilitar MQTT
                    </label>
                    <small>Ativa ou desativa completamente o cliente MQTT</small>
                </div>
            </div>

            <!-- Configura√ß√£o do Broker -->
            <div class="config-card" id="mqtt_config_section">
                <h2>üåê Configura√ß√£o do Broker</h2>
                
                <div class="form-group">
                    <label for="broker_url">Broker URL: *</label>
                    <input type="text" id="broker_url" name="broker_url" value="{{BROKER_URL}}" required>
                    <small>Exemplo: mqtt://broker.hivemq.com ou mqtts://broker.example.com</small>
                </div>

                <div class="form-group">
                    <label for="port">Porta: *</label>
                    <input type="number" id="port" name="port" value="{{PORT}}" min="1" max="65535" required>
                    <small>Padr√£o: 1883 (MQTT) ou 8883 (MQTTS)</small>
                </div>

                <div class="form-group">
                    <label for="client_id">Client ID: *</label>
                    <input type="text" id="client_id" name="client_id" value="{{CLIENT_ID}}" required>
                    <small>Identificador √∫nico do cliente no broker</small>
                </div>
            </div>

            <!-- Autentica√ß√£o -->
            <div class="config-card" id="auth_section">
                <h2>üîê Autentica√ß√£o</h2>
                
                <div class="form-group">
                    <label for="username">Usu√°rio:</label>
                    <input type="text" id="username" name="username" value="{{USERNAME}}">
                    <small>Deixe vazio para brokers p√∫blicos sem autentica√ß√£o</small>
                </div>

                <div class="form-group">
                    <label for="password">Senha:</label>
                    <input type="password" id="password" name="password" placeholder="[Protegida]">
                    <small>Deixe vazio para brokers p√∫blicos sem autentica√ß√£o</small>
                </div>
            </div>

            <!-- Configura√ß√£o TLS/SSL -->
            <div class="config-card" id="tls_section">
                <h2>üîí Configura√ß√£o TLS/SSL</h2>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="tls_enabled" name="tls_enabled"{{TLS_ENABLED_CHECKED}}>
                        Habilitar TLS/SSL
                    </label>
                    <small>Converte automaticamente mqtt:// para mqtts://</small>
                </div>

                <div class="form-group" id="cert_section" style="display: none;">
                    <label>Certificado CA:</label>
                    <div style="margin: 10px 0;">
                        <label>
                            <input type="radio" name="cert_type" value="default" checked>
                            Usar certificado padr√£o (ISRG Root X1)
                        </label>
                    </div>
                    <div style="margin: 10px 0;">
                        <label>
                            <input type="radio" name="cert_type" value="custom">
                            Enviar certificado personalizado
                        </label>
                    </div>
                    <div id="cert_upload" style="display: none; margin-top: 10px;">
                        <label for="cert_file">Arquivo do Certificado (.pem):</label>
                        <input type="file" id="cert_file" name="cert_file" accept=".pem,.crt,.cer">
                        <small style="display: block; color: #666; margin-top: 5px;">
                            Selecione um arquivo de certificado CA em formato PEM
                        </small>
                    </div>
                </div>
            </div>

            <!-- Configura√ß√µes de QoS e Comportamento -->
            <div class="config-card" id="qos_section">
                <h2>üìä Configura√ß√µes de QoS e Comportamento</h2>
                
                <div class="form-group">
                    <label for="qos">N√≠vel QoS:</label>
                    <select id="qos" name="qos">
                        <option value="0"{{QOS_0_SELECTED}}>0 - Fire and forget</option>
                        <option value="1"{{QOS_1_SELECTED}}>1 - At least once</option>
                        <option value="2"{{QOS_2_SELECTED}}>2 - Exactly once</option>
                    </select>
                    <small>N√≠vel de garantia de entrega das mensagens</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="retain" name="retain"{{RETAIN_CHECKED}}>
                        Reter mensagens no broker
                    </label>
                    <small>Mant√©m a √∫ltima mensagem armazenada no broker</small>
                </div>

                <div class="form-group">
                    <label for="publish_interval">Intervalo de Publica√ß√£o (ms):</label>
                    <input type="number" id="publish_interval" name="publish_interval" value="{{PUBLISH_INTERVAL}}" min="100" max="60000">
                    <small>Intervalo entre publica√ß√µes (100ms a 60s)</small>
                </div>
            </div>

            <!-- T√≥picos MQTT (Informativo) -->
            <div class="config-card">
                <h2>üìã T√≥picos MQTT Publicados</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Heat:</span>
                        <span class="info-value">esp32/sonda_lambda/heat</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Lambda:</span>
                        <span class="info-value">esp32/sonda_lambda/lambda</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">O2:</span>
                        <span class="info-value">esp32/sonda_lambda/o2</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Error:</span>
                        <span class="info-value">esp32/sonda_lambda/error</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Output:</span>
                        <span class="info-value">esp32/sonda_lambda/output</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value">esp32/sonda_lambda/status</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Todos os dados:</span>
                        <span class="info-value">esp32/sonda_lambda/data</span>
                    </div>
                </div>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="form-group">
                <button type="submit" class="btn btn-primary">üíæ Salvar Configura√ß√£o</button>
                <button type="button" class="btn btn-secondary" onclick="testConnection()">üîß Testar Conex√£o</button>
                <button type="button" class="btn btn-secondary" onclick="history.back()">‚¨ÖÔ∏è Voltar</button>
            </div>
        </form>

        <!-- Status da Conex√£o -->
        <div class="config-card" id="status_section">
            <h2>üì∂ Status da Conex√£o MQTT</h2>
            <div id="mqtt_status" class="status-indicator">
                <span id="status_text">Verificando...</span>
                <div id="status_icon">‚è≥</div>
            </div>
        </div>
    </div>

    <script>
        // Controlar visibilidade das se√ß√µes baseado no checkbox principal
        const mqttEnabledCheckbox = document.getElementById('mqtt_enabled');
        const configSections = document.querySelectorAll('#mqtt_config_section, #auth_section, #tls_section, #qos_section');
        
        function toggleMqttSections() {
            const isEnabled = mqttEnabledCheckbox.checked;
            configSections.forEach(section => {
                section.style.display = isEnabled ? 'block' : 'none';
            });
        }

        // Controlar exibi√ß√£o dos campos de certificado
        const tlsCheckbox = document.getElementById('tls_enabled');
        const certSection = document.getElementById('cert_section');
        const certRadios = document.querySelectorAll('input[name="cert_type"]');
        const certUpload = document.getElementById('cert_upload');
        
        function toggleCertSection() {
            if (tlsCheckbox.checked) {
                certSection.style.display = 'block';
            } else {
                certSection.style.display = 'none';
                certUpload.style.display = 'none';
            }
        }
        
        function toggleCertUpload() {
            const customSelected = document.querySelector('input[name="cert_type"]:checked').value === 'custom';
            certUpload.style.display = customSelected ? 'block' : 'none';
        }

        // Event listeners
        mqttEnabledCheckbox.addEventListener('change', toggleMqttSections);
        tlsCheckbox.addEventListener('change', toggleCertSection);
        certRadios.forEach(radio => {
            radio.addEventListener('change', toggleCertUpload);
        });
        
        // Estado inicial
        toggleMqttSections();
        toggleCertSection();
        toggleCertUpload();

        // Fun√ß√£o para testar conex√£o
        function testConnection() {
            const statusText = document.getElementById('status_text');
            const statusIcon = document.getElementById('status_icon');
            
            statusText.textContent = 'Testando conex√£o...';
            statusIcon.textContent = '‚è≥';
            
            // Simular teste (implementar API real)
            setTimeout(() => {
                statusText.textContent = 'Teste de conex√£o implementado na API';
                statusIcon.textContent = '‚ÑπÔ∏è';
            }, 2000);
        }

        // Verificar status MQTT periodicamente
        function checkMqttStatus() {
            fetch('/api/mqtt/status')
                .then(response => response.json())
                .then(data => {
                    const statusText = document.getElementById('status_text');
                    const statusIcon = document.getElementById('status_icon');
                    
                    switch(data.status) {
                        case 'connected':
                            statusText.textContent = 'Conectado ao broker';
                            statusIcon.textContent = '‚úÖ';
                            break;
                        case 'connecting':
                            statusText.textContent = 'Conectando...';
                            statusIcon.textContent = 'üîÑ';
                            break;
                        case 'disconnected':
                            statusText.textContent = 'Desconectado';
                            statusIcon.textContent = '‚ùå';
                            break;
                        default:
                            statusText.textContent = 'Status desconhecido';
                            statusIcon.textContent = '‚ùì';
                    }
                })
                .catch(() => {
                    const statusText = document.getElementById('status_text');
                    const statusIcon = document.getElementById('status_icon');
                    statusText.textContent = 'Erro ao verificar status';
                    statusIcon.textContent = '‚ö†Ô∏è';
                });
        }

        // Verificar status inicialmente e a cada 5 segundos
        checkMqttStatus();
        setInterval(checkMqttStatus, 5000);
    </script>
</body>
</html>
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status-connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-connecting { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        .tls-section {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .tls-enabled {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .cert-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cert-upload:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }
        
        .cert-upload.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .cert-info {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .test-connection {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        .test-connection:hover {
            background: #138496;
        }
        
        .hidden {
            display: none;
        }
        
        .port-auto {
            color: #6c757d;
            font-size: 12px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="config-device-container">
        <div class="header">
            <h1 class="config-device-title">üîê Configura√ß√£o MQTT/TLS</h1>
            <a class="btn btn-voltar" href="/admin">‚¨ÖÔ∏è Voltar</a>
        </div>
        
        <div class="brand">
            <div class="brand-main">
                <img src="https://infitech.com.br/images/logo.jpg" alt="Infitech - Automa√ß√£o" class="brand-logo">
                <h2 class="brand-company">Infitech - Automa√ß√£o</h2>
            </div>
            <div class="brand-program">Programa: <strong>MCT-01</strong></div>
        </div>

        <!-- Status da Conex√£o MQTT -->
        <div id="mqtt-status" class="mqtt-status status-disconnected">
            üîå Status: Desconectado
        </div>

        <!-- Configura√ß√£o B√°sica -->
        <div class="config-card">
            <h2>üì° Configura√ß√£o B√°sica do Broker</h2>
            
            <div class="config-form-group">
                <label class="config-label">Broker MQTT:</label>
                <input class="config-input" type="text" id="broker_url" name="broker_url" 
                       value="{{MQTT_BROKER_URL}}" placeholder="broker.hivemq.com">
                <small>Ex: broker.hivemq.com ou mqtts://secure.broker.com</small>
            </div>

            <div class="config-form-group">
                <label class="config-label">Porta:</label>
                <input class="config-input" type="number" id="port" name="port" 
                       value="{{MQTT_PORT}}" min="1" max="65535">
                <div class="port-auto">Padr√£o: 1883 (MQTT) | 8883 (MQTTS)</div>
            </div>

            <div class="config-form-group">
                <label class="config-label">Client ID:</label>
                <input class="config-input" type="text" id="client_id" name="client_id" 
                       value="{{MQTT_CLIENT_ID}}" placeholder="ESP32_SondaLambda">
            </div>
        </div>

        <!-- Configura√ß√£o TLS/SSL -->
        <div class="config-card">
            <h2>üîí Seguran√ßa TLS/SSL</h2>
            
            <div class="config-form-group">
                <label class="config-label">
                    <input type="checkbox" id="tls_enabled" name="tls_enabled" {{MQTT_TLS_CHECKED}}>
                    Habilitar TLS/SSL (Conex√£o Segura)
                </label>
                <small>Ativa criptografia para proteger os dados transmitidos</small>
            </div>

            <div id="tls-section" class="tls-section hidden">
                <h3>üìú Certificado de Autoridade (CA)</h3>
                
                <div class="config-form-group">
                    <label class="config-label">Certificado:</label>
                    <select class="config-input" id="ca_certificate" name="ca_certificate">
                        <option value="/spiffs/isrgrootx1.pem" {{MQTT_CA_DEFAULT_SELECTED}}>
                            Let's Encrypt (Inclu√≠do)
                        </option>
                        <option value="/spiffs/custom_ca.pem" {{MQTT_CA_CUSTOM_SELECTED}}>
                            Certificado Personalizado
                        </option>
                    </select>
                </div>

                <div id="cert-upload-section" class="hidden">
                    <div class="cert-upload" onclick="document.getElementById('cert-file').click()">
                        <div>üìÅ Clique aqui ou arraste um arquivo .pem</div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                            Formatos aceitos: .pem, .crt, .cer (m√°x. 10KB)
                        </div>
                        <input type="file" id="cert-file" accept=".pem,.crt,.cer" style="display: none;">
                    </div>
                    
                    <div id="cert-status" class="cert-info hidden"></div>
                </div>

                <div class="cert-info">
                    <strong>‚ÑπÔ∏è Informa√ß√£o sobre Certificados:</strong><br>
                    ‚Ä¢ <strong>Let's Encrypt:</strong> Funciona com a maioria dos brokers p√∫blicos<br>
                    ‚Ä¢ <strong>Personalizado:</strong> Para brokers corporativos ou auto-assinados<br>
                    ‚Ä¢ O certificado √© usado apenas para verificar a identidade do servidor
                </div>
            </div>
        </div>

        <!-- Autentica√ß√£o (Opcional) -->
        <div class="config-card">
            <h2>üîë Autentica√ß√£o (Opcional)</h2>
            
            <div class="config-form-group">
                <label class="config-label">Usu√°rio:</label>
                <input class="config-input" type="text" id="username" name="username" 
                       value="{{MQTT_USERNAME}}" placeholder="Deixe vazio se n√£o necess√°rio">
            </div>

            <div class="config-form-group">
                <label class="config-label">Senha:</label>
                <input class="config-input" type="password" id="password" name="password" 
                       value="{{MQTT_PASSWORD}}" placeholder="Deixe vazio se n√£o necess√°rio">
            </div>
        </div>

        <!-- Configura√ß√µes Avan√ßadas -->
        <div class="config-card">
            <h2>‚öôÔ∏è Configura√ß√µes Avan√ßadas</h2>
            
            <div class="config-form-group">
                <label class="config-label">QoS (Quality of Service):</label>
                <select class="config-input" id="qos" name="qos">
                    <option value="0" {{MQTT_QOS_0_SELECTED}}>0 - M√°ximo uma vez (r√°pido)</option>
                    <option value="1" {{MQTT_QOS_1_SELECTED}}>1 - Pelo menos uma vez (padr√£o)</option>
                    <option value="2" {{MQTT_QOS_2_SELECTED}}>2 - Exatamente uma vez (lento)</option>
                </select>
            </div>

            <div class="config-form-group">
                <label class="config-label">Intervalo de Publica√ß√£o (ms):</label>
                <input class="config-input" type="number" id="publish_interval" name="publish_interval" 
                       value="{{MQTT_PUBLISH_INTERVAL}}" min="100" max="60000" step="100">
                <small>Tempo entre envios de dados (1000ms = 1 segundo)</small>
            </div>

            <div class="config-form-group">
                <label class="config-label">
                    <input type="checkbox" id="retain" name="retain" {{MQTT_RETAIN_CHECKED}}>
                    Reter Mensagens (Retain)
                </label>
                <small>Broker mant√©m a √∫ltima mensagem para novos subscribers</small>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="config-card" style="text-align: center;">
            <button type="button" class="test-connection" onclick="testConnection()">
                üîç Testar Conex√£o
            </button>
            
            <button type="button" class="btn-config btn-primary" onclick="saveConfig()">
                üíæ Salvar Configura√ß√£o
            </button>
            
            <a class="btn-config btn-secondary" href="/admin">
                ‚Ü©Ô∏è Cancelar
            </a>
        </div>

        <!-- Logs de Teste -->
        <div class="config-card">
            <h2>üìù Log de Teste</h2>
            <div id="test-log" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                Pronto para testar conex√£o...
            </div>
        </div>
    </div>


            document.getElementById('cert-file').addEventListener('change', handleCertUpload);
            
            // Drag and drop para certificado
            const certUpload = document.querySelector('.cert-upload');


    </script>
</body>
</html>