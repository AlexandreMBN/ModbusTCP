<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√£o MQTT - Medidor de Combust√£o</title>
    <link rel="stylesheet" href="/css/styles.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 0;
        }

        .config-device-container {
            max-width: 800px;
            margin: 40px auto;
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-device-title {
            margin: 0;
            color: #333;
        }

        .btn-voltar {
            background: #ccc;
            padding: 8px 12px;
            text-decoration: none;
            border-radius: 6px;
            color: #000;
        }

        .brand {
            text-align: center;
            margin-top: 15px;
        }

        .brand-logo {
            width: 100px;
            border-radius: 8px;
        }

        .config-card {
            margin-top: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: #fafafa;
        }

        .config-card h2 {
            margin-top: 0;
            color: #333;
        }

        .config-form-group {
            margin: 10px 0;
        }

        .config-label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .config-input {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .btn-config, .test-connection {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }

        .btn-config:hover, .test-connection:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .mqtt-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }

        .status-connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-connecting { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }

        .tls-section {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .cert-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .cert-upload:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .cert-info {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .port-auto {
            color: #6c757d;
            font-size: 12px;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="config-device-container">
        <div class="header">
            <h1 class="config-device-title">üì° Configura√ß√£o MQTT</h1>
            <a class="btn-voltar" href="/admin">‚¨ÖÔ∏è Voltar</a>
        </div>

        <div class="brand">
            <img src="https://infitech.com.br/images/logo.jpg" alt="Infitech - Automa√ß√£o" class="brand-logo">
            <h2>Infitech - Automa√ß√£o</h2>
            <div class="brand-program">Programa: <strong>MCT-01</strong></div>
        </div>

        <!-- Status -->
        <div id="mqtt-status" class="mqtt-status status-disconnected">üîå Status: Desconectado</div>

        <!-- Configura√ß√£o B√°sica -->
        <div class="config-card">
            <h2>üåê Configura√ß√£o do Broker</h2>
            <div class="config-form-group">
                <label class="config-label">Broker URL:</label>
                <input class="config-input" id="broker_url" name="broker_url" value="{{MQTT_BROKER_URL}}" placeholder="broker.hivemq.com">
                <small>Exemplo: mqtt://broker.hivemq.com ou mqtts://broker.exemplo.com</small>
            </div>
            <div class="config-form-group">
                <label class="config-label">Porta:</label>
                <input class="config-input" type="number" id="port" name="port" value="{{MQTT_PORT}}" min="1" max="65535">
                <div class="port-auto">Padr√£o: 1883 (MQTT) | 8883 (MQTTS)</div>
            </div>
            <div class="config-form-group">
                <label class="config-label">Client ID:</label>
                <input class="config-input" id="client_id" name="client_id" value="{{MQTT_CLIENT_ID}}" placeholder="ESP32_SondaLambda">
            </div>
        </div>

        <!-- TLS -->
        <div class="config-card">
            <h2>üîí Seguran√ßa TLS/SSL</h2>
            <div class="config-form-group">
                <label><input type="checkbox" id="tls_enabled" name="tls_enabled" {{MQTT_TLS_CHECKED}}> Habilitar TLS/SSL</label>
                <small>Ativa criptografia para proteger os dados transmitidos</small>
            </div>
            <div id="tls-section" class="tls-section hidden">
                <h3>üìú Certificado de Autoridade (CA)</h3>
                <div class="config-form-group">
                    <label class="config-label">Certificado:</label>
                    <select class="config-input" id="ca_certificate" name="ca_certificate">
                        <option value="/spiffs/isrgrootx1.pem" {{MQTT_CA_DEFAULT_SELECTED}}>Let's Encrypt (Inclu√≠do)</option>
                        <option value="/spiffs/custom_ca.pem" {{MQTT_CA_CUSTOM_SELECTED}}>Certificado Personalizado</option>
                    </select>
                </div>
                <div id="cert-upload-section" class="hidden">
                    <div class="cert-upload" onclick="document.getElementById('cert-file').click()">
                        üìÅ Clique aqui ou arraste um arquivo .pem
                        <input type="file" id="cert-file" accept=".pem,.crt,.cer" style="display:none;">
                    </div>
                    <div id="cert-status" class="cert-info hidden"></div>
                </div>
            </div>
        </div>

        <!-- Autentica√ß√£o -->
        <div class="config-card">
            <h2>üîë Autentica√ß√£o</h2>
            <div class="config-form-group">
                <label class="config-label">Usu√°rio:</label>
                <input class="config-input" id="username" name="username" value="{{MQTT_USERNAME}}">
            </div>
            <div class="config-form-group">
                <label class="config-label">Senha:</label>
                <input class="config-input" type="password" id="password" name="password" value="{{MQTT_PASSWORD}}">
            </div>
        </div>

        <!-- Avan√ßado -->
        <div class="config-card">
            <h2>‚öôÔ∏è Configura√ß√µes Avan√ßadas</h2>
            <div class="config-form-group">
                <label class="config-label">QoS:</label>
                <select class="config-input" id="qos" name="qos">
                    <option value="0" {{MQTT_QOS_0_SELECTED}}>0 - M√°ximo uma vez</option>
                    <option value="1" {{MQTT_QOS_1_SELECTED}}>1 - Pelo menos uma vez</option>
                    <option value="2" {{MQTT_QOS_2_SELECTED}}>2 - Exatamente uma vez</option>
                </select>
            </div>
            <div class="config-form-group">
                <label class="config-label">Intervalo de Publica√ß√£o (ms):</label>
                <input class="config-input" type="number" id="publish_interval" name="publish_interval" value="{{MQTT_PUBLISH_INTERVAL}}" min="100" max="60000">
            </div>
            <div class="config-form-group">
                <label><input type="checkbox" id="retain" name="retain" {{MQTT_RETAIN_CHECKED}}> Reter Mensagens</label>
            </div>
        </div>

        <!-- Bot√µes -->
        <div class="config-card" style="text-align:center;">
            <button class="test-connection" onclick="testConnection()">üîç Testar Conex√£o</button>
            <button class="btn-config" onclick="saveConfig()">üíæ Salvar</button>
            <a class="btn-config btn-secondary" href="/admin">‚Ü©Ô∏è Cancelar</a>
        </div>

        <!-- Log -->
        <div class="config-card">
            <h2>üìù Log de Teste</h2>
            <div id="test-log" style="background:#f8f9fa; border:1px solid #dee2e6; border-radius:4px; padding:10px; height:150px; overflow-y:auto; font-family:monospace;">
                Pronto para testar conex√£o...
            </div>
        </div>
    </div>

    <script>
        const tlsCheckbox = document.getElementById('tls_enabled');
        const tlsSection = document.getElementById('tls-section');
        const certSelect = document.getElementById('ca_certificate');
        const certUploadSection = document.getElementById('cert-upload-section');

        tlsCheckbox.addEventListener('change', () => {
            tlsSection.classList.toggle('hidden', !tlsCheckbox.checked);
        });

        certSelect.addEventListener('change', () => {
            certUploadSection.classList.toggle('hidden', certSelect.value !== '/spiffs/custom_ca.pem');
        });

        function testConnection() {
            const log = document.getElementById('test-log');
            log.innerHTML += "<br>‚è≥ Testando conex√£o com broker...";
            setTimeout(() => {
                log.innerHTML += "<br>‚úÖ Conex√£o de teste simulada (implementar backend real).";
            }, 2000);
        }

        function saveConfig() {
            alert("üíæ Configura√ß√£o salva com sucesso (simulado).");
        }
    </script>
</body>
</html>
